<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>

	<head th:replace="~{fragments :: page_head(${pageTitle}, 'tag')}" />
	<link rel="stylesheet" th:href="@{/richtext/richtext.min.css}" />
	<script th:src="@{/richtext/jquery.richtext.js}"></script>
	<link rel="stylesheet" type="text/css" th:href="@{/style-product-form.css}" />
</head>

<body>

	<div class="container-fluid">
		<div class="w-100">
			<div class="d-flex w-100">
				<div th:replace="~{sidebar :: sidebar}" class="w-25"></div>
				<div class="d-flex flex-column" style="width: 88%;">
					<div th:replace="~{navigation :: menu}"></div>
					<div class="w-80">
						<div class="p-5">
							<h2 style="text-align: center;">Manage Products | [[${pageTitle}]]</h2>

							<form th:action="@{/products/save}" method="post" th:object="${product}"
								onsubmit="return checkUnique(this)" >
								<!-- Product tabs -->
								<ul class="nav nav-tabs" id="myTab" role="tablist" style="background: darkgrey;font-size: 14px;font-weight: bold;border-radius: 15px 15px 0px 0px;">
									<li class="nav-item" >
										<a class="nav-link active" data-toggle="tab" href="#overview"
											role="tab" style="border-radius: 15px 15px 15px 0px;">Overview</a>
									</li>
									<li class="nav-item" >
										<a class="nav-link" data-toggle="tab" href="#description"
											role="tab" style="border-radius: 15px 15px 15px 15px;">Description</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" data-toggle="tab" href="#images" role="tab" style="border-radius: 15px 15px 15px 15px;">Images</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" data-toggle="tab" href="#details" role="tab" style="border-radius: 15px 15px 15px 15px;">Details</a>
									</li>

									<li class="nav-item">
										<a class="nav-link" data-toggle="tab" href="#shipping" role="tab" style="border-radius: 15px 15px 15px 15px;">Shipping</a>
									</li>
								</ul>

								<!-- Tab panes -->
								<div class="tab-content p-3" >
									<div class="tab-pane active p-3" id="overview" role="tabpanel">
										<div th:replace="~{products/product_overview :: content}" />
									</div>
									<div class="tab-pane" id="description" role="tabpanel">
										<div th:replace="~{products/product_description :: content}" />
									</div>
									<div class="tab-pane" id="images" role="tabpanel"><span>Images</span></div>
									<div class="tab-pane" id="details" role="tabpanel"><span>Details</span></div>
									<div class="tab-pane p-3" id="shipping" role="tabpanel"><span>
										<div th:replace="~{products/product_shipping :: content}" /></span>
									</div>
								</div>

								<!--Action-->
								<div class="text-center">
									<input type="submit" value="Save" class="btn btn-primary m-3" />
									<input type="button" value="Cancel" class="btn btn-secondary" id="buttonCancel" />
								</div>
							</form>

							<div th:replace="~{modal_fragments :: modal_dialog}"></div>
							<div th:replace="~{fragments :: footer}"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript">
	moduleURL = "[[@{/products}]]";
	brandModuleURL = "[[@{/brands}]]";


	dropdownBands = $("#brand");
	dropdownCategories = $("#category");

	$(document).ready(function () {
		$("#shortDescription").richText();
		$("#fullDescription").richText();

		dropdownBands.change(function () {
			dropdownCategories.empty();
			getCategories();
		});
		getCategories();
	});

	function getCategories() {
		brandId = dropdownBands.val();
		url = brandModuleURL + "/" + brandId + "/categories";

		$.get(url, function (responseJson) {
			$.each(responseJson, function (index, category) {
				$("<option>").val(category.id).text(category.name).appendTo(dropdownCategories);
			});
		});
	}

	function checkUnique(form) {
		productId = $('#id').val();
		productName = $('#name').val().trim();

		csrfValue = $("input[name='_csrf']").val();

		url = "[[@{/products/check_unique}]]";

		params = {id: productId, name: productName, _csrf: csrfValue};

		$.post(url, params, function (response) {
			if (response == "OK") {
				form.submit();
			} else if (response == "Duplicate") {
				showWarningModal("There is another product having the same name " + productName);
			}
			else {
				showErrorModal("Unknown response from server");
			}
		}).fail(function () {
			showErrorModal("Could not connect to the server");
		});

		return false;
	}
</script>
<script th:src="@{/js/common_form.js}"></script>

</html>